<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>go的pprof使用 - ShangguanHong</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="ShangguanHong" /><meta name="description" content="原文地址：Golang 大杀器之性能剖析 PProf 前言 写了几吨代码，实现了几百个接口。功能测试也通过了，终于成功的部署上线了 结果，性能不佳，什么鬼？😭" /><meta name="keywords" content="go, golang, hugo" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://shangguanhong.github.io/2020/02/26/go%E7%9A%84pprof%E4%BD%BF%E7%94%A8/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="go的pprof使用" />
<meta property="og:description" content="原文地址：Golang 大杀器之性能剖析 PProf 前言 写了几吨代码，实现了几百个接口。功能测试也通过了，终于成功的部署上线了 结果，性能不佳，什么鬼？😭" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://shangguanhong.github.io/2020/02/26/go%E7%9A%84pprof%E4%BD%BF%E7%94%A8/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-02-26T22:01:46+00:00" />
<meta property="article:modified_time" content="2020-02-26T22:01:46+00:00" />

<meta itemprop="name" content="go的pprof使用">
<meta itemprop="description" content="原文地址：Golang 大杀器之性能剖析 PProf 前言 写了几吨代码，实现了几百个接口。功能测试也通过了，终于成功的部署上线了 结果，性能不佳，什么鬼？😭"><meta itemprop="datePublished" content="2020-02-26T22:01:46+00:00" />
<meta itemprop="dateModified" content="2020-02-26T22:01:46+00:00" />
<meta itemprop="wordCount" content="2583">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="go的pprof使用"/>
<meta name="twitter:description" content="原文地址：Golang 大杀器之性能剖析 PProf 前言 写了几吨代码，实现了几百个接口。功能测试也通过了，终于成功的部署上线了 结果，性能不佳，什么鬼？😭"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">赏我一个好梦如旧</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">赏我一个好梦如旧</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">go的pprof使用</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-02-26 </span>
        <div class="post-category">
            <a href="/categories/go%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"> Go学习笔记 </a>
            </div>
          <span class="more-meta"> 约 2583 字 </span>
          <span class="more-meta"> 预计阅读 6 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#pprof">PProf</a></li>
    <li><a href="#是什么">是什么</a></li>
    <li><a href="#支持什么使用模式">支持什么使用模式</a></li>
    <li><a href="#可以做什么">可以做什么</a></li>
    <li><a href="#一个简单的例子">一个简单的例子</a></li>
    <li><a href="#分析">分析</a>
      <ul>
        <li><a href="#一通过-web-界面">一、通过 Web 界面</a></li>
        <li><a href="#二通过交互式终端使用">二、通过交互式终端使用</a></li>
        <li><a href="#三pprof可视化界面">三、PProf可视化界面</a></li>
        <li><a href="#四pprof-火焰图">四、PProf 火焰图</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>原文地址：<a href="https://book.eddycjy.com/golang/tools/go-tool-pprof.html">Golang 大杀器之性能剖析 PProf</a></p>
<h1 id="前言">前言</h1>
<p>写了几吨代码，实现了几百个接口。功能测试也通过了，终于成功的部署上线了</p>
<p>结果，性能不佳，什么鬼？😭</p>
<h1 id="想做性能分析">想做性能分析</h1>
<h2 id="pprof">PProf</h2>
<p>想要进行性能优化，首先瞩目在 Go 自身提供的工具链来作为分析依据，本文将带你学习、使用 Go 后花园，涉及如下：</p>
<ul>
<li>runtime/pprof：采集程序（非 Server）的运行数据进行分析</li>
<li>net/http/pprof：采集 HTTP Server 的运行时数据进行分析</li>
</ul>
<h2 id="是什么">是什么</h2>
<p>pprof 是用于可视化和分析性能分析数据的工具</p>
<p>pprof 以 <a href="https://github.com/google/pprof/blob/master/proto/profile.proto">profile.proto</a> 读取分析样本的集合，并生成报告以可视化并帮助分析数据（支持文本和图形报告）</p>
<p>profile.proto 是一个 Protocol Buffer v3 的描述文件，它描述了一组 callstack 和 symbolization 信息， 作用是表示统计分析的一组采样的调用栈，是很常见的 stacktrace 配置文件格式</p>
<h2 id="支持什么使用模式">支持什么使用模式</h2>
<ul>
<li>Report generation：报告生成</li>
<li>Interactive terminal use：交互式终端使用</li>
<li>Web interface：Web 界面</li>
</ul>
<h2 id="可以做什么">可以做什么</h2>
<ul>
<li>CPU Profiling：CPU 分析，按照一定的频率采集所监听的应用程序 CPU（含寄存器）的使用情况，可确定应用程序在主动消耗 CPU 周期时花费时间的位置</li>
<li>Memory Profiling：内存分析，在应用程序进行堆分配时记录堆栈跟踪，用于监视当前和历史内存使用情况，以及检查内存泄漏</li>
<li>Block Profiling：阻塞分析，记录 goroutine 阻塞等待同步（包括定时器通道）的位置</li>
<li>Mutex Profiling：互斥锁分析，报告互斥锁的竞争情况</li>
</ul>
<h2 id="一个简单的例子">一个简单的例子</h2>
<p>我们将编写一个简单且有点问题的例子，用于基本的程序初步分析</p>
<p>demo.go文件内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="s">&#34;net/http/pprof&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">datas</span> <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;Hello World!&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;0.0.0.0:6060&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Add</span><span class="p">(</span><span class="nx">str</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sData</span> <span class="o">:=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">datas</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">datas</span><span class="p">,</span> <span class="nx">sData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">sData</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行这个文件，你的 HTTP 服务会多出 /debug/pprof 的 endpoint 可用于观察应用程序的情况</p>
<h2 id="分析">分析</h2>
<h3 id="一通过-web-界面">一、通过 Web 界面</h3>
<p>查看当前总览：访问 <code>http://127.0.0.1:6060/debug/pprof/</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/debug/pprof/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Types of profiles available:
</span></span><span class="line"><span class="cl">Count	Profile
</span></span><span class="line"><span class="cl">26	allocs
</span></span><span class="line"><span class="cl">0	block
</span></span><span class="line"><span class="cl">0	cmdline
</span></span><span class="line"><span class="cl">4	goroutine
</span></span><span class="line"><span class="cl">26	heap
</span></span><span class="line"><span class="cl">0	mutex
</span></span><span class="line"><span class="cl">0	profile
</span></span><span class="line"><span class="cl">8	threadcreate
</span></span><span class="line"><span class="cl">0	trace
</span></span><span class="line"><span class="cl">full goroutine stack dump
</span></span><span class="line"><span class="cl">Profile Descriptions:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">allocs: A sampling of all past memory allocations
</span></span><span class="line"><span class="cl">block: Stack traces that led to blocking on synchronization primitives
</span></span><span class="line"><span class="cl">cmdline: The command line invocation of the current program
</span></span><span class="line"><span class="cl">goroutine: Stack traces of all current goroutines
</span></span><span class="line"><span class="cl">heap: A sampling of memory allocations of live objects. You can specify the gc GET parameter to run GC before taking the heap sample.
</span></span><span class="line"><span class="cl">mutex: Stack traces of holders of contended mutexes
</span></span><span class="line"><span class="cl">profile: CPU profile. You can specify the duration in the seconds GET parameter. After you get the profile file, use the go tool pprof command to investigate the profile.
</span></span><span class="line"><span class="cl">threadcreate: Stack traces that led to the creation of new OS threads
</span></span><span class="line"><span class="cl">trace: A trace of execution of the current program. You can specify the duration in the seconds GET parameter. After you get the trace file, use the go tool trace command to investigate the trace.
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个页面有许多子页面，咱们继续深究下去，看看可以得到什么？</p>
<ul>
<li>cpu（CPU Profiling）: <code>$HOST/debug/pprof/profile</code>，默认进行 30s 的 CPU Profiling，得到一个分析用的 profile 文件</li>
<li>block（Block Profiling）：<code>$HOST/debug/pprof/block</code>，查看导致阻塞同步的堆栈跟踪</li>
<li>goroutine：<code>$HOST/debug/pprof/goroutine</code>，查看当前所有运行的 goroutines 堆栈跟踪</li>
<li>heap（Memory Profiling）: <code>$HOST/debug/pprof/heap</code>，查看活动对象的内存分配情况</li>
<li>mutex（Mutex Profiling）：<code>$HOST/debug/pprof/mutex</code>，查看导致互斥锁的竞争持有者的堆栈跟踪</li>
<li>threadcreate：<code>$HOST/debug/pprof/threadcreate</code>，查看创建新OS线程的堆栈跟踪</li>
</ul>
<h3 id="二通过交互式终端使用">二、通过交互式终端使用</h3>
<p>（1）go tool pprof http://localhost:6060/debug/pprof/profile?seconds=60</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ go tool pprof http://localhost:6060/debug/pprof/profile?seconds<span class="o">=</span><span class="m">60</span>
</span></span><span class="line"><span class="cl">Fetching profile over HTTP from http://localhost:6060/debug/pprof/profile?seconds<span class="o">=</span><span class="m">60</span>
</span></span><span class="line"><span class="cl">Saved profile in C:<span class="se">\U</span>sers<span class="se">\f</span>ate<span class="se">\p</span>prof<span class="se">\p</span>prof.samples.cpu.001.pb.gz
</span></span><span class="line"><span class="cl">Type: cpu
</span></span><span class="line"><span class="cl">Time: Feb 26, <span class="m">2020</span> at 10:15pm <span class="o">(</span>CST<span class="o">)</span>
</span></span><span class="line"><span class="cl">Duration: 1mins, Total <span class="nv">samples</span> <span class="o">=</span> 1.06mins <span class="o">(</span>106.05%<span class="o">)</span>
</span></span><span class="line"><span class="cl">Entering interactive mode <span class="o">(</span><span class="nb">type</span> <span class="s2">&#34;help&#34;</span> <span class="k">for</span> commands, <span class="s2">&#34;o&#34;</span> <span class="k">for</span> options<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行该命令后，需等待 60 秒（可调整 seconds 的值），pprof 会进行 CPU Profiling。结束后将默认进入 pprof 的交互式命令模式，可以对分析的结果进行查看或导出。具体可执行 <code>pprof help</code> 查看命令说明</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span> top
</span></span><span class="line"><span class="cl">Showing nodes accounting <span class="k">for</span> 50.42s, 79.02% of 63.81s total
</span></span><span class="line"><span class="cl">Dropped <span class="m">154</span> nodes <span class="o">(</span>cum &lt;<span class="o">=</span> 0.32s<span class="o">)</span>
</span></span><span class="line"><span class="cl">Showing top <span class="m">10</span> nodes out of <span class="m">52</span>
</span></span><span class="line"><span class="cl">      flat  flat%   sum%        cum   cum%
</span></span><span class="line"><span class="cl">    41.54s 65.10% 65.10%     42.19s 66.12%  runtime.cgocall
</span></span><span class="line"><span class="cl">     1.42s  2.23% 67.32%      1.78s  2.79%  log.itoa
</span></span><span class="line"><span class="cl">     1.39s  2.18% 69.50%      3.26s  5.11%  runtime.mallocgc
</span></span><span class="line"><span class="cl">     1.21s  1.90% 71.40%      1.21s  1.90%  runtime.memmove
</span></span><span class="line"><span class="cl">     1.05s  1.65% 73.04%      3.73s  5.85%  runtime.scanobject
</span></span><span class="line"><span class="cl">     0.98s  1.54% 74.58%      1.52s  2.38%  runtime.findObject
</span></span><span class="line"><span class="cl">     0.78s  1.22% 75.80%      3.96s  6.21%  log.<span class="o">(</span>*Logger<span class="o">)</span>.formatHeader
</span></span><span class="line"><span class="cl">     0.74s  1.16% 76.96%     51.16s 80.18%  log.<span class="o">(</span>*Logger<span class="o">)</span>.Output
</span></span><span class="line"><span class="cl">     0.73s  1.14% 78.11%      1.24s  1.94%  runtime.greyobject
</span></span><span class="line"><span class="cl">     0.58s  0.91% 79.02%     45.08s 70.65%  internal/poll.<span class="o">(</span>*FD<span class="o">)</span>.Write
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>flat：给定函数上运行耗时</li>
<li>flat%：同上的 CPU 运行耗时总比例</li>
<li>sum%：给定函数累积使用 CPU 总比例</li>
<li>cum：当前函数加上它之上的调用运行总耗时</li>
<li>cum%：同上的 CPU 运行耗时总比例</li>
</ul>
<p>最后一列为函数名称，在大多数的情况下，我们可以通过这五列得出一个应用程序的运行情况，加以优化 🤔</p>
<p>（2）go tool pprof http://localhost:6060/debug/pprof/heap</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ go tool pprof http://localhost:6060/debug/pprof/heap
</span></span><span class="line"><span class="cl">Fetching profile over HTTP from http://localhost:6060/debug/pprof/heap
</span></span><span class="line"><span class="cl">Saved profile in C:\Users\fate\pprof\pprof.alloc_objects.alloc_space.inuse_objects.inuse_space.002.pb.gz
</span></span><span class="line"><span class="cl">Type: inuse_space
</span></span><span class="line"><span class="cl">Time: Feb 26, 2020 at 10:17pm (CST)
</span></span><span class="line"><span class="cl">Entering interactive mode (type &#34;help&#34; for commands, &#34;o&#34; for options)
</span></span><span class="line"><span class="cl">(pprof) top
</span></span><span class="line"><span class="cl">Showing nodes accounting for 734.09MB, 100% of 734.09MB total
</span></span><span class="line"><span class="cl">      flat  flat%   sum%        cum   cum%
</span></span><span class="line"><span class="cl">  734.09MB   100%   100%   734.09MB   100%  main.Add (inline)
</span></span><span class="line"><span class="cl">         0     0%   100%   734.09MB   100%  main.main.func1
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>-inuse_space：分析应用程序的常驻内存占用情况</li>
<li>-alloc_objects：分析应用程序的内存临时分配情况</li>
</ul>
<p>（3） go tool pprof http://localhost:6060/debug/pprof/block</p>
<p>（4） go tool pprof http://localhost:6060/debug/pprof/mutex</p>
<h3 id="三pprof可视化界面">三、PProf可视化界面</h3>
<p>这是令人期待的一小节。在这之前，我们需要简单的编写好测试用例来跑一下</p>
<h4 id="编写测试用例">编写测试用例</h4>
<p>（1）新建 demo_test.go，文件内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">url</span> <span class="p">=</span> <span class="s">&#34;Hello World!&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestAdd</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="o">:=</span> <span class="nf">Add</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">s</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Test.Add error!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">BenchmarkAdd</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Add</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>（2）执行测试用例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="err">$</span> <span class="k">go</span> <span class="nx">test</span> <span class="nx">bench</span><span class="p">=.</span> <span class="o">-</span><span class="nx">cpuprofile</span><span class="p">=</span><span class="nx">cpu</span><span class="p">.</span><span class="nx">prof</span>
</span></span><span class="line"><span class="cl"><span class="nx">goos</span><span class="p">:</span> <span class="nx">windows</span>
</span></span><span class="line"><span class="cl"><span class="nx">goarch</span><span class="p">:</span> <span class="nx">amd64</span>
</span></span><span class="line"><span class="cl"><span class="nx">pkg</span><span class="p">:</span> <span class="nx">demo</span><span class="o">/</span><span class="nx">gammar</span>
</span></span><span class="line"><span class="cl"><span class="nx">BenchmarkAdd</span><span class="o">-</span><span class="mi">4</span>           <span class="mi">5002905</span>               <span class="mi">228</span> <span class="nx">ns</span><span class="o">/</span><span class="nx">op</span>
</span></span><span class="line"><span class="cl"><span class="nx">PASS</span>
</span></span><span class="line"><span class="cl"><span class="nx">ok</span>      <span class="nx">demo</span><span class="o">/</span><span class="nx">gammar</span>     <span class="mf">2.478</span><span class="nx">s</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>-memprofile 也可以了解一下</p>
<h4 id="启动-pprof-可视化界面">启动 PProf 可视化界面</h4>
<p><strong>方法一：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ go tool pprof -http<span class="o">=</span>:8080 cpu.prof	
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>方法二：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ go tool pprof cpu.prof
</span></span><span class="line"><span class="cl">$ <span class="o">(</span>pprof<span class="o">)</span> web		
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果出现<code>failed to execute dot. Is Graphviz installed? Error: exec: &quot;dot&quot;: executable file not found in %PATH%</code>,就是提示你要安装 <code>Graphviz</code> 了(请右拐谷歌)</p>
<h4 id="查看-pprof-可视化界面">查看 PProf 可视化界面</h4>
<p>（1）Top</p>
<p><img src="https://raw.githubusercontent.com/ShangguanHong/PictureBed/master/image-20200226222959289.png" alt="image-20200226222959289"></p>
<p>(2) Graph</p>
<p><img src="https://raw.githubusercontent.com/ShangguanHong/PictureBed/master/image-20200226223105986.png" alt="image-20200226223105986"></p>
<p>框越大，线越粗代表它占用的时间越大哦</p>
<p>（3）Peek</p>
<p><img src="https://raw.githubusercontent.com/ShangguanHong/PictureBed/master/image-20200226223142402.png" alt="image-20200226223142402"></p>
<p>（4）Source</p>
<p><img src="https://raw.githubusercontent.com/ShangguanHong/PictureBed/master/image-20200226223225867.png" alt="image-20200226223225867"></p>
<p>通过 PProf 的可视化界面，我们能够更方便、更直观的看到 Go 应用程序的调用链、使用情况等，并且在 View 菜单栏中，还支持如上多种方式的切换</p>
<p>你想想，在烦恼不知道什么问题的时候，能用这些辅助工具来检测问题，是不是瞬间效率翻倍了呢 👌</p>
<h3 id="四pprof-火焰图">四、PProf 火焰图</h3>
<p>另一种可视化数据的方法是火焰图，需手动安装原生 PProf 工具：</p>
<p>（1） 安装 PProf</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ go get -u github.com/google/pprof
</span></span></code></pre></td></tr></table>
</div>
</div><p>（2） 启动 PProf 可视化界面:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ pprof -http=:8080 cpu.prof
</span></span></code></pre></td></tr></table>
</div>
</div><p>（3） 查看 PProf 可视化界面</p>
<p>打开 PProf 的可视化界面时，你会明显发现比官方工具链的 PProf 精致一些，并且多了 Flame Graph（火焰图）</p>
<p>它就是本次的目标之一，它的最大优点是动态的。调用顺序由上到下（A -&gt; B -&gt; C -&gt; D），每一块代表一个函数，越大代表占用 CPU 的时间更长。同时它也支持点击块深入进行分析！</p>
<p><img src="https://raw.githubusercontent.com/ShangguanHong/PictureBed/master/image-20200226223709330.png" alt="image-20200226223709330"></p>
<h1 id="总结">总结</h1>
<p>在本章节，粗略地介绍了 Go 的性能利器 PProf。在特定的场景中，PProf 给定位、剖析问题带了极大的帮助</p>
<p>希望本文对你有所帮助，另外建议能够自己实际操作一遍，最好是可以深入琢磨一下，内含大量的用法、知识点 🤓</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">ShangguanHong</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-02-26
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2020/03/02/go%E8%BF%9E%E6%8E%A5mysql/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Go连接MySQL</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/2020/02/16/ubuntu18.04%E6%9B%B4%E6%8D%A2%E5%9B%BD%E5%86%85%E6%BA%90/">
            <span class="next-text nav-default">Ubuntu18.04更换国内源</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  
  <div id="vcomments"></div>
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'X0gLmyOh1himl7jHPYcpKKop-gzGzoHsz',
        appKey: 'hoYFzkrMqrD9SyRNpkiNf0LH',
        notify:  false ,
        verify:  false ,
        avatar:'mm',
        placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
        visitor:  false 
    });
  </script>

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:www.sgh1450280694@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/ShangguanHong" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/5590338381" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://space.bilibili.com/105190849" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://shangguanhong.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>ShangguanHong</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
